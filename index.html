<html>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="./test.css"/>
    </head>
    <body>

        <ul class="nav nav-tabs">
            <li class="active"> 
                <a href="#email" data-toggle="tab">Email Categorization</a>
            </li>
            <li>
                <a href="#location" data-toggle="tab">Location Visualization</a>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
            <div class="tab-pane fade in active" id="email">
                <p>Upload your .mbox file here and let the wonders of apache spark and LDA categorize you emails based on subject lines</p>
                <input name="myFile" type="file" id="f">
            </div>
            <div class="tab-pane fade" id="location">
                <p>Upload your search history and map activity and watch as spark will pick out every place Google thinks you've ever been</p>
                <input name="myFile1" type="file" id="f1">
                <input name="myFile2" type="file" id="f2">
            </div>
        </div>


        <div id="progressBar"><div></div></div>
        
    </body>



    <script
                                                       src="https://code.jquery.com/jquery-3.3.1.js"
                                                       integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
                                                       crossorigin="anonymous"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script>

        //function progress(percent, $element) {
        //        var progressBarWidth = percent * $element.width() / 100;
        //        $element.find('div').animate({ width: progressBarWidth }, 500).html(percent + "% ");
        //}


        function sendToDanielsCluster(result){
                console.log(result)
                $.post("http://helena.cs.colostate.edu:47309",result)
                $.post("http://hartford.cs.colostate.edu:47309",result)
                $.post("http://providence.cs.colostate.edu:47309",result)
                $.post("http://juneau.cs.colostate.edu:47309",result)
                $.post("http://concord.cs.colostate.edu:47309",result)
                $.post("http://charleston.cs.colostate.edu:47309",result)
                $.post("http://boise.cs.colostate.edu:47309",result)
                $.post("http://bismarck.cs.colostate.edu:47309",result)
                $.post("http://topeka.cs.colostate.edu:47309",result)
                $.post("http://dover.cs.colostate.edu:47309",result)
                $.post("http://carson-city.cs.colostate.edu:47309",result)

        }
    
    
        var loaded = "";
        function loadLocationData() {
            if (!this.files.length) return;
            readFileByChunk(this.files[0], false, function(result){
                if(loaded == ""){
                    console.log("First")
                    loaded = result;
                }else{
                    console.log("BOTH")
                    sendToDanielsCluster(result + "\n" + loaded + "\r\n")
                }
            });
        }
        document.getElementById('f1').onchange = loadLocationData;
        document.getElementById('f2').onchange = loadLocationData;
        document.getElementById('f').onchange = function() {
            if (!this.files.length) return;
            readFileByChunk(this.files[0], true,function(result){
                result += "\r\n"

                $.post("http://olympia.cs.colostate.edu:45409",result)
                $.post("http://boise.cs.colostate.edu:45409",result)
                $.post("http://albany.cs.colostate.edu:45409",result)
                $.post("http://annapolis.cs.colostate.edu:45409",result)
                $.post("http://baton-rouge.cs.colostate.edu:45409", result)
                $.post("http://bismarck.cs.colostate.edu:45409",result)
                $.post("http://sacramento.cs.colostate.edu:45409", result)
                $.post("http://carson-city.cs.colostate.edu:45409", result)
                $.post("http://charleston.cs.colostate.edu:45409", result)
                $.post("http://cheyenne.cs.colostate.edu:45409", result)
                $.post("http://austin.cs.colostate.edu:45409", result)
                $.post("http://salem.cs.colostate.edu:45409", result)
                $.post("http://phoenix.cs.colostate.edu:45409", result)
                $.post("http://pierre.cs.colostate.edu:45409", result)
                $.post("http://salt-lake-city.cs.colostate.edu:45409",result)
            });
        };

function readFileByChunk(file, subjectsOnly, callback){
    var CHUNK_SIZE = 1000000;
    var offset = 0;
    var length = 0
    var fr = new FileReader();
    toBeSent = ""
    fr.onload = function() {
        //$("#done").text("REMAINING: ", ((file.size - offset) / file.size * 100).toFixed(2), "%");
        //progress((file.size - offset) / file.size * 100, $("#progressBar"))
        console.log("REMAINING: ", ((file.size - offset) / file.size * 100).toFixed(2), "%");
        lines = fr.result.split(/\r?\n/);
        length += lines.length;
            lines.forEach(function(element) {
                if(subjectsOnly){
                    if(element.startsWith("Subject:")){
                        toBeSent += element + "\n"
                    }
                }else{
                    toBeSent += element + "\n"
                }
            });
            offset += CHUNK_SIZE;
            seek();
    }
    fr.onerror = function() {
        callback("ERROR")
    };

    seek();

    function seek() {
        if (offset >= file.size) {
            console.log("DONE")
            return callback(length + "\n"+toBeSent);
        }
        var slice = file.slice(offset, offset + CHUNK_SIZE);
        fr.readAsText(slice);
    }
}

    </script>
</html>
